rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is an admin (exists in admins collection)
    // Admin documents use EMAIL as document ID, not UID
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }
    
    // Check if user can read admin data (either is admin or checking their own status)
    function canReadAdminData(docId) {
      return isAuthenticated() && (isAdmin() || request.auth.uid == docId);
    }

    // ============================================
    // USERS/CUSTOMERS COLLECTION
    // ============================================
    // Users can read and write only their own document
    // Admins can read all users
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if isAdmin() || isOwner(userId);
    }
    
    match /customers/{customerId} {
      allow read: if isAdmin() || isOwner(customerId);
      // Allow create if user is authenticated AND creating their own document
      allow create: if isAuthenticated() && request.auth.uid == customerId;
      allow update: if isAdmin() || isOwner(customerId);
      allow delete: if isAdmin();
    }

    // ============================================
    // INVENTORY/PRODUCTS COLLECTION
    // ============================================
    // Everyone can READ products (public catalog)
    // Only ADMINS can WRITE (create, update, delete)
    match /produtos/{produtoId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /rental_equipments/{equipmentId} {
      allow read: if true;
      allow write: if true; // TEMPORARIO: Permitir seed
    }
    
    match /inventory/{itemId} {
      allow read: if true; // Public catalog
      allow create, update, delete: if isAdmin(); // Only admins can manage inventory
    }

    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    // Everyone can read categories (for filtering)
    // Only admins can write
    match /categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // ADMINS COLLECTION
    // ============================================
    // Authenticated users can read their own admin status
    // Admins can read all admin documents
    // NO ONE can write (must be managed via Firebase Console or secure script)
    match /admins/{adminId} {
      allow read: if canReadAdminData(adminId);
      allow write: if false; // LOCKED: Admins must be added via Firebase Console or secure script
    }

    // ============================================
    // RESERVAS COLLECTION
    // ============================================
    // Users can create reservations
    // Users can only read/update their own reservations
    // Admins can read/update all reservations
    match /reservas/{reservaId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.usuario_id == request.auth.uid;
      
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.usuario_id == request.auth.uid);
      
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.usuario_id == request.auth.uid);
      
      allow delete: if isAdmin();
    }

    // ============================================
    // ORDERS COLLECTION
    // ============================================
    // Users can create orders
    // Users can only read/update their own orders
    // Admins can read/update all orders
    match /orders/{orderId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      allow delete: if isAdmin();
    }

    // ============================================
    // COMPANIES (Wallet) COLLECTION
    // ============================================
    // Users can read/write their own company wallet
    // Admins can read all companies
    match /companies/{companyId} {
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      allow delete: if isAdmin();
    }

    // ============================================
    // WALLET TRANSACTIONS
    // ============================================
    // Users can create and read their own transactions
    // Admins can read all transactions
    match /wallet_transactions/{txId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PACKAGES COLLECTION (if exists)
    // ============================================
    match /packages/{packageId} {
      allow read: if true; // Public packages
      allow write: if isAdmin();
    }
    
    // ============================================
    // PROMOTIONS COLLECTION (if exists)
    // ============================================
    match /promotions/{promoId} {
      allow read: if true; // Public promotions
      allow write: if isAdmin();
    }

    // ============================================
    // SITE CONTENT COLLECTION (CMS)
    // ============================================
    // Public can read site content
    // Only admins can modify site content
    match /site_content/{docId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Only admins can edit
    }
  }
}
